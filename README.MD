
## Опис
Цей скрипт здійснює автоматичне витягування даних з бази даних MySQL, трансформує їх та відправляє на Power BI. 

Основна мета цього скрипта полягає в зборі та аналізі інформації про платежі за паркування.

* .env файл: це файл, який містить змінні середовища. Вони прокидаються в докер і читаються з файла локально

* send_to_bi.py: це основний скрипт Python, який виконує всю роботу. Цей скрипт виконує наступні дії: Завантажує змінні середовища з .env файлу.
Встановлює з'єднання з MySQL базою даних та витягує дані.
Перевіряє, чи були вже відправлені конкретні дані до Power BI.
Відправляє дані в Power BI через API.
Позначає, які дані були відправлені, щоб уникнути повторної відправки.

* docker-compose.prod.yaml: цей файл Docker Compose визначає сервіс Python, який використовує ваш скрипт. Цей сервіс перебудовується кожного разу, коли ви запускаєте Docker Compose, і використовує змінні середовища з .env файлу.

## Як запустити

### Попередні вимоги
Перед локальным запуском потрібно встановити залежності і створити .env
```bash
pip install -r requirements.txt
```

### Запуск локально
Cтворити .env в корні проекту тестувалось на 3.11 інтерпретаторі

```bash
python send_to_bi.py
```

## Запуск за допомогою Docker
Попередньо створити .env в корні проекту
```bash
docker-compose -f docker-compose.prod.yaml up -d
```

### Якщо треба перезалити все з нуля

```bash
rm -rf ./db-data/parking
docker-compose -f docker-compose.prod.yaml up -d --force-recreate --build
```
## Параметри
Скрипт використовує наступні параметри, які зберігаються в файлі .env:

- `API_ENDPOINT`: URL для відправлення даних на Power BI.
- `DB_NAME`: Ім'я бази даних.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль бази даних.
- `DB_HOST`: Хост бази даних.
- `DB_PORT`: Порт бази даних.

### Додавання мапінгу паркінгів
Мапінг паркінгів можна додати, викликавши функцію `save_terminal_parking_association` з відповідними параметрами в вашому скрипті. Наприклад:

```python
save_terminal_parking_association('1 вїзд 14 парковка', 'Паркінг 14', 12)
save_terminal_parking_association('2 вїзд 14 парковка', 'Паркінг 14', 13)
```

## Періодичність запуску
Скрипт запускається автоматично кожні 5 хвилин. Час між запусками можна змінити, змінивши параметр `Timer` в функції `periodic_task`.

## Збереження даних
Sqllite база містить данні про вже відправлені чеки, а також номер останнього відправленого(щоб рахувати наступний батч від нього). База створюється в тому ж каталозі що і скрипт. Також мапінг паркоматів до паркінгів(бо база пакінгу не зберігає це)

## Логування
Лог, в проді в stdout, або тому ж каталозі PowerBiSentLog.log як(туди пишеться статус обробки і відправки, також ексепшени)

## 2023-01-01
UPDATE last_processed_operation SET mysql_id = 1749327, operation_id = 61672525811 WHERE id = 1;